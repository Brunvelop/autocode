<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autocode - AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-5">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white p-6 rounded-2xl shadow-2xl mb-5">
            <h1 class="text-4xl font-bold text-gray-800 text-center mb-2">
                ğŸ¤– Autocode AI Chat
            </h1>
            <p class="text-center text-gray-600">
                Chat con memoria, acceso a herramientas MCP y selecciÃ³n de modelo
            </p>
            <div class="flex justify-center gap-4 mt-4">
                <a href="/functions" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                    ğŸš€ Funciones API
                </a>
                <a href="/health" class="bg-green-100 hover:bg-green-200 text-green-800 font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                    ğŸ’š Health Check
                </a>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Model Selector -->
            <div class="bg-indigo-600 p-4 flex items-center gap-4">
                <label for="modelSelect" class="text-white font-semibold">Modelo:</label>
                <select id="modelSelect" class="flex-1 p-2 rounded-lg border-2 border-indigo-400 focus:border-white focus:outline-none bg-white text-gray-800">
                    <option value="openrouter/openai/gpt-4o">GPT-4o (OpenAI)</option>
                    <option value="openrouter/x-ai/grok-4">Grok-4 (xAI)</option>
                    <option value="openrouter/anthropic/claude-sonnet-4.5">Claude Sonnet 4.5 (Anthropic)</option>
                    <option value="openrouter/openai/gpt-5">GPT-5 (OpenAI)</option>
                    <option value="openrouter/openai/gpt-5-codex">GPT-5 Codex (OpenAI)</option>
                </select>
                <button id="clearBtn" class="bg-white hover:bg-gray-100 text-indigo-600 font-semibold py-2 px-4 rounded-lg transition-colors">
                    ğŸ—‘ï¸ Limpiar Chat
                </button>
            </div>

            <!-- Messages Area -->
            <div id="messagesContainer" class="h-96 overflow-y-auto p-6 bg-gray-50 space-y-4">
                <div class="text-center text-gray-500 italic" id="emptyState">
                    Inicia una conversaciÃ³n... ğŸ’¬
                </div>
            </div>

            <!-- Input Area -->
            <div class="bg-white p-4 border-t border-gray-200">
                <form id="chatForm" class="flex gap-3">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Escribe tu mensaje..." 
                        class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                        required
                    />
                    <button 
                        type="submit" 
                        id="sendBtn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                        Enviar ğŸš€
                    </button>
                </form>
            </div>
        </div>

        <!-- Info -->
        <div class="mt-5 p-4 bg-white rounded-lg shadow-md text-sm text-gray-600">
            <strong>ğŸ’¡ CaracterÃ­sticas:</strong>
            <ul class="mt-2 pl-5 list-disc">
                <li><strong>Memoria:</strong> El chat mantiene el contexto de toda la conversaciÃ³n</li>
                <li><strong>Herramientas MCP:</strong> El asistente puede usar todas las funciones registradas (add, multiply, generate_code, etc.)</li>
                <li><strong>DSPy ReAct:</strong> Razonamiento automÃ¡tico sobre quÃ© herramientas usar</li>
                <li><strong>Modelos mÃºltiples:</strong> Cambia entre diferentes LLMs sin perder la conversaciÃ³n</li>
            </ul>
        </div>
    </div>

    <script>
        class AutocodeChat {
            constructor() {
                this.conversationHistory = [];
                this.messagesContainer = document.getElementById('messagesContainer');
                this.messageInput = document.getElementById('messageInput');
                this.chatForm = document.getElementById('chatForm');
                this.sendBtn = document.getElementById('sendBtn');
                this.modelSelect = document.getElementById('modelSelect');
                this.clearBtn = document.getElementById('clearBtn');
                this.emptyState = document.getElementById('emptyState');
                
                this.init();
            }

            init() {
                this.chatForm.addEventListener('submit', (e) => this.handleSubmit(e));
                this.clearBtn.addEventListener('click', () => this.clearChat());
            }

            async handleSubmit(event) {
                event.preventDefault();
                
                const message = this.messageInput.value.trim();
                if (!message) return;

                // Add user message to UI
                this.addMessage('user', message);
                this.messageInput.value = '';
                this.emptyState.style.display = 'none';

                // Disable input while processing
                this.setLoading(true);

                try {
                    const response = await this.sendMessage(message);
                    
                    if (response.error) {
                        this.addMessage('error', response.error);
                    } else {
                        this.addMessage('assistant', response.response);
                        // Update conversation history
                        this.conversationHistory = response.conversation_history || [];
                    }
                } catch (error) {
                    this.addMessage('error', `Error: ${error.message}`);
                } finally {
                    this.setLoading(false);
                }
            }

            async sendMessage(message) {
                const model = this.modelSelect.value;
                
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: this.conversationHistory,
                        model: model,
                        max_tokens: 16000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }

                const data = await response.json();
                // Extraer del campo 'result' si existe (formato GenericOutput)
                return data.result || data;
            }

            addMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `max-w-3xl rounded-2xl px-4 py-3 ${
                    role === 'user' 
                        ? 'bg-indigo-600 text-white' 
                        : role === 'error'
                        ? 'bg-red-100 text-red-800 border border-red-300'
                        : 'bg-white text-gray-800 shadow-md border border-gray-200'
                }`;
                
                const label = document.createElement('div');
                label.className = 'font-bold text-sm mb-1';
                label.textContent = role === 'user' ? 'ğŸ‘¤ TÃº' : role === 'error' ? 'âŒ Error' : 'ğŸ¤– Asistente';
                
                const text = document.createElement('div');
                text.className = 'whitespace-pre-wrap break-words';
                text.textContent = content;
                
                bubble.appendChild(label);
                bubble.appendChild(text);
                messageDiv.appendChild(bubble);
                
                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            setLoading(loading) {
                this.sendBtn.disabled = loading;
                this.messageInput.disabled = loading;
                this.sendBtn.textContent = loading ? 'Pensando... ğŸ¤”' : 'Enviar ğŸš€';
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            clearChat() {
                if (confirm('Â¿Seguro que quieres limpiar el chat? Se perderÃ¡ todo el historial.')) {
                    this.conversationHistory = [];
                    this.messagesContainer.innerHTML = '<div class="text-center text-gray-500 italic" id="emptyState">Inicia una conversaciÃ³n... ğŸ’¬</div>';
                    this.emptyState = document.getElementById('emptyState');
                }
            }
        }

        // Initialize chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => new AutocodeChat());
    </script>
</body>
</html>
