{% extends "base.html" %}

{% block title %}Autocode - Dynamic API Interface{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-5">
    <div class="bg-white p-8 rounded-2xl shadow-2xl ring-1 ring-black/5 mb-5">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-8">üöÄ Autocode Framework - Dynamic API Interface</h1>
        <p class="text-center text-gray-600 mb-8">Interfaz autom√°tica para todas las funciones expuestas en la API</p>
        
        <div id="loading" class="text-center p-10 text-gray-600">
            <p>Cargando funciones disponibles...</p>
        </div>
        
        <div id="functionsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-5 mt-5 hidden"></div>
        
        <div class="mt-5 p-4 bg-blue-50 border border-blue-200 rounded-xl ring-1 ring-black/5 text-sm">
            <strong>Arquitectura Din√°mica:</strong>
            <ul class="mt-2 pl-5 list-disc">
                <li><strong>Auto-detecci√≥n:</strong> La p√°gina consulta <code>/functions/details</code> para obtener todas las funciones disponibles</li>
                <li><strong>Generaci√≥n din√°mica:</strong> Se crean formularios autom√°ticamente basados en los par√°metros de cada funci√≥n</li>
                <li><strong>M√©todos flexibles:</strong> Soporte para GET y POST seg√∫n la configuraci√≥n de cada funci√≥n</li>
                <li><strong>Tipado inteligente:</strong> Inputs apropiados seg√∫n el tipo de cada par√°metro</li>
                <li><strong>Valores por defecto:</strong> Pre-llenado autom√°tico de par√°metros opcionales</li>
            </ul>
        </div>
    </div>
</div>

<script>
    class DynamicAPIInterface {
        constructor() {
            this.functions = {};
            this.init();
        }

        async init() {
            try {
                await this.loadFunctions();
                this.renderFunctions();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('functionsContainer').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading functions:', error);
                this.showError('Error cargando las funciones: ' + error.message);
            }
        }

        async loadFunctions() {
            const response = await fetch('/functions/details');
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            const data = await response.json();
            this.functions = data.functions;
            console.log('Loaded functions:', this.functions);
        }

        renderFunctions() {
            const container = document.getElementById('functionsContainer');
            container.innerHTML = '';
            for (const [funcName, funcInfo] of Object.entries(this.functions)) {
                container.appendChild(this.createFunctionCard(funcName, funcInfo));
            }
        }

        createFunctionCard(funcName, funcInfo) {
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-xl shadow-lg ring-1 ring-black/5 hover:shadow-xl transition';
            card.innerHTML = `
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-lg font-bold text-gray-800">üîß ${funcInfo.name}</span>
                    <div class="flex gap-1">
                        ${funcInfo.http_methods.map(method => 
                            `<span class="px-2.5 py-0.5 text-xs font-bold rounded-full ring-1 ring-black/5 ${method === 'GET' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${method}</span>`
                        ).join('')}
                    </div>
                </div>
                <div class="text-gray-600 text-sm mb-4 italic">${funcInfo.description}</div>
                <form id="form-${funcName}">
                    ${this.createMethodSelector(funcName, funcInfo.http_methods)}
                    ${this.createParameterInputs(funcInfo.parameters)}
                    <button type="submit" class="w-full bg-gradient-to-r from-emerald-500 to-green-600 text-white py-2.5 px-4 rounded-xl shadow hover:shadow-lg transition">Ejecutar ${funcInfo.name} ‚ö°</button>
                </form>
                <div id="result-${funcName}" class="mt-4 p-3 rounded font-mono text-sm whitespace-pre-wrap hidden"></div>
            `;
            card.querySelector(`#form-${funcName}`).addEventListener('submit', (e) => this.handleFormSubmit(e, funcName, funcInfo));
            return card;
        }

        createMethodSelector(funcName, methods) {
            if (methods.length === 1) return `<input type="hidden" name="method" value="${methods[0]}">`;
            return `
                <div class="mb-4">
                    <label for="method-${funcName}" class="block mb-1 font-bold text-gray-700 text-sm">M√©todo HTTP:</label>
                    <select id="method-${funcName}" name="method" class="w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                        ${methods.map(method => `<option value="${method}">${method}</option>`).join('')}
                    </select>
                </div>
            `;
        }

        createParameterInputs(parameters) {
            if (parameters.length === 0) return '<p class="text-gray-500 italic mb-4">Esta funci√≥n no requiere par√°metros.</p>';
            return parameters.map(param => {
                const requiredMark = param.required ? '<span class="text-red-500">*</span>' : '';
                const defaultValue = param.default !== null ? param.default : '';
                
                if (param.choices && Array.isArray(param.choices) && param.choices.length > 0) {
                    const options = param.choices.map(choice => 
                        `<option value="${choice}" ${choice === defaultValue ? 'selected' : ''}>${choice}</option>`
                    ).join('');
                    return `
                        <div class="mb-4">
                            <label for="param-${param.name}" class="block mb-1 font-bold text-gray-700 text-sm">
                                ${param.name} ${requiredMark}
                                <span class="text-xs text-gray-500 font-normal ml-1">(${param.type}${param.default !== null ? `, default: ${param.default}` : ''}) - ${param.description}</span>
                            </label>
                            <select id="param-${param.name}" name="${param.name}" ${param.required ? 'required' : ''}
                                    class="w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                                ${options}
                            </select>
                        </div>
                    `;
                } else {
                    const inputType = param.type === 'int' || param.type === 'float' ? 'number' : 'text';
                    return `
                        <div class="mb-4">
                            <label for="param-${param.name}" class="block mb-1 font-bold text-gray-700 text-sm">
                                ${param.name} ${requiredMark}
                                <span class="text-xs text-gray-500 font-normal ml-1">(${param.type}${param.default !== null ? `, default: ${param.default}` : ''}) - ${param.description}</span>
                            </label>
                            <input type="${inputType}" id="param-${param.name}" name="${param.name}" value="${defaultValue}" 
                                   ${param.required ? 'required' : ''} placeholder="${param.description}"
                                   class="w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                    `;
                }
            }).join('');
        }

        async handleFormSubmit(event, funcName, funcInfo) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const resultDiv = document.getElementById(`result-${funcName}`);
            const formData = new FormData(form);
            const method = formData.get('method') || funcInfo.http_methods[0];
            const params = {};

            for (const param of funcInfo.parameters) {
                const value = formData.get(param.name);
                if (value !== null && value !== '') {
                    params[param.name] = param.type === 'int' ? parseInt(value) : 
                                       param.type === 'float' ? parseFloat(value) : value;
                }
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Ejecutando...';
            resultDiv.classList.add('hidden');

            try {
                const result = await this.callAPI(funcName, params, method);
                this.showResult(resultDiv, result, false);
            } catch (error) {
                this.showResult(resultDiv, `Error: ${error.message}`, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = `Ejecutar ${funcInfo.name} ‚ö°`;
            }
        }

        async callAPI(funcName, params, method) {
            let url = `/${funcName}`;
            let options = { method, headers: { 'Content-Type': 'application/json' } };

            if (method === 'GET') {
                const queryString = new URLSearchParams(params).toString();
                if (queryString) url += `?${queryString}`;
            } else {
                options.body = JSON.stringify(params);
            }

            const response = await fetch(url, options);
            if (!response.ok) {
                let errorMsg = `HTTP ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.detail || errorMsg;
                } catch {
                    errorMsg = response.statusText || errorMsg;
                }
                throw new Error(errorMsg);
            }
            
            const data = await response.json();
            console.log(`${method} ${funcName} response:`, data);
            return data.result !== undefined ? data.result : data;
        }

        showResult(resultDiv, content, isError = false) {
            resultDiv.textContent = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
            resultDiv.className = `mt-4 p-3 rounded-xl font-mono text-sm whitespace-pre-wrap shadow ${isError ? 'bg-red-50 border border-red-400 text-red-700 ring-1 ring-red-200' : 'bg-green-50 border border-green-400 text-green-800 ring-1 ring-green-200'}`;
            resultDiv.classList.remove('hidden');
        }

        showError(message) {
            document.getElementById('loading').innerHTML = `
                <p class="text-red-600">‚ùå ${message}</p>
                <button onclick="location.reload()" class="mt-2 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">Reintentar</button>
            `;
        }
    }

    document.addEventListener('DOMContentLoaded', () => new DynamicAPIInterface());
</script>
{% endblock %}
