<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context Bar - Unit Tests</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 bg-gray-100 min-h-screen">
    <div class="flex items-center gap-4 mb-2">
        <a href="/tests" class="text-indigo-600 hover:text-indigo-800">‚Üê Tests</a>
        <h1 class="text-3xl font-bold">üìä Context Bar - Unit Tests</h1>
    </div>
    
    <div id="summary" class="mb-6 p-4 bg-white rounded-lg shadow"></div>
    <div id="results" class="space-y-2"></div>

    <script type="module">
        import { TestRunner } from '../../utils/test-runner.js'; 
        
        import '/elements/chat/context-bar.js';

        const runner = new TestRunner();

        runner.group('ContextBar', () => {
            // ========================================
            // TEST 1: Registro del Custom Element
            // ========================================
            runner.test('ContextBar: se registra como custom element', async () => {
                await runner.waitForElement('context-bar');
                runner.assertTrue(customElements.get('context-bar'));
            });

            // ========================================
            // TEST 2: Propiedades current y max
            // ========================================
            runner.test('ContextBar: propiedades current y max son reactivas', async (stage) => {
                const el = document.createElement('context-bar');
                stage.appendChild(el);
                await el.updateComplete;
                
                runner.assertEqual(el.current, 0, 'current debe ser 0 por defecto');
                runner.assertEqual(el.max, 0, 'max debe ser 0 por defecto');
                
                el.setAttribute('current', '5000');
                el.setAttribute('max', '10000');
                await el.updateComplete;
                
                runner.assertEqual(el.current, 5000, 'current debe actualizarse');
                runner.assertEqual(el.max, 10000, 'max debe actualizarse');
            });

            // ========================================
            // TEST 3: API update()
            // ========================================
            runner.test('ContextBar: update() actualiza current y max', async (stage) => {
                const el = document.createElement('context-bar');
                stage.appendChild(el);
                await el.updateComplete;
                
                el.update(3000, 8000);
                await el.updateComplete;
                
                runner.assertEqual(el.current, 3000, 'update() debe actualizar current');
                runner.assertEqual(el.max, 8000, 'update() debe actualizar max');
            });

            // ========================================
            // TEST 4: API getPercentage()
            // ========================================
            runner.test('ContextBar: getPercentage() calcula correctamente', async (stage) => {
                const el = document.createElement('context-bar');
                stage.appendChild(el);
                
                el.update(5000, 10000);
                await el.updateComplete;
                
                runner.assertEqual(el.getPercentage(), 50, 'Debe calcular 50%');
                
                el.update(7500, 10000);
                await el.updateComplete;
                
                runner.assertEqual(el.getPercentage(), 75, 'Debe calcular 75%');
                
                el.update(0, 10000);
                await el.updateComplete;
                
                runner.assertEqual(el.getPercentage(), 0, 'Debe calcular 0%');
            });

            // ========================================
            // TEST 5: getPercentage() con max = 0
            // ========================================
            runner.test('ContextBar: getPercentage() retorna 0 cuando max es 0', async (stage) => {
                const el = document.createElement('context-bar');
                stage.appendChild(el);
                
                el.update(100, 0);
                await el.updateComplete;
                
                runner.assertEqual(el.getPercentage(), 0, 'Debe retornar 0 para evitar divisi√≥n por cero');
            });

            // ========================================
            // TEST 6: Renderiza stats con formato correcto
            // ========================================
            runner.test('ContextBar: muestra stats con formato current / max', async (stage) => {
                const el = document.createElement('context-bar');
                el.setAttribute('current', '5000');
                el.setAttribute('max', '10000');
                stage.appendChild(el);
                await el.updateComplete;
                
                const stats = el.shadowRoot.querySelector('.stats');
                runner.assertTrue(stats, 'Debe tener elemento stats');
                
                const text = stats.textContent;
                runner.assertTrue(text.includes('/'), 'Debe mostrar formato current / max');
                runner.assertTrue(text.includes('5'), 'Debe contener el valor 5,000');
                runner.assertTrue(text.includes('10'), 'Debe contener el valor 10,000');
            });

            // ========================================
            // TEST 7: Formatea n√∫meros con separadores
            // ========================================
            runner.test('ContextBar: formatea n√∫meros con separadores de miles', async (stage) => {
                const el = document.createElement('context-bar');
                el.update(1234567, 9876543);
                stage.appendChild(el);
                await el.updateComplete;
                
                const stats = el.shadowRoot.querySelector('.stats');
                const text = stats.textContent;
                
                // Deber√≠a tener formato con comas o puntos (dependiendo del locale)
                // Al menos debe contener los d√≠gitos separados
                runner.assertTrue(
                    text.includes('1,234,567') || text.includes('1.234.567') || text.includes('1 234 567'),
                    'Debe formatear n√∫meros grandes con separadores'
                );
            });

            // ========================================
            // TEST 8: Renderiza barra de progreso
            // ========================================
            runner.test('ContextBar: renderiza barra de progreso visual', async (stage) => {
                const el = document.createElement('context-bar');
                el.update(5000, 10000);
                stage.appendChild(el);
                await el.updateComplete;
                
                const bar = el.shadowRoot.querySelector('.bar');
                runner.assertTrue(bar, 'Debe tener elemento bar');
                
                // Verificar que tiene ancho proporcional (aproximadamente 50%)
                const barStyle = window.getComputedStyle(bar);
                const width = barStyle.width;
                // El ancho deber√≠a estar cerca del 50% del contenedor
                runner.assertTrue(width !== '0px', 'Barra debe tener ancho visible');
            });

            // ========================================
            // TEST 9: Color verde cuando < 70%
            // ========================================
            runner.test('ContextBar: usa color verde cuando porcentaje < 70%', async (stage) => {
                const el = document.createElement('context-bar');
                el.update(3000, 10000); // 30%
                stage.appendChild(el);
                await el.updateComplete;
                
                const bar = el.shadowRoot.querySelector('.bar');
                runner.assertTrue(bar.classList.contains('green'), 'Debe tener clase green bajo 70%');
            });

            // ========================================
            // TEST 10: Color amarillo cuando 70-90%
            // ========================================
            runner.test('ContextBar: usa color amarillo cuando porcentaje entre 70-90%', async (stage) => {
                const el = document.createElement('context-bar');
                el.update(8000, 10000); // 80%
                stage.appendChild(el);
                await el.updateComplete;
                
                const bar = el.shadowRoot.querySelector('.bar');
                runner.assertTrue(bar.classList.contains('yellow'), 'Debe tener clase yellow entre 70-90%');
            });

            // ========================================
            // TEST 11: Color rojo cuando > 90%
            // ========================================
            runner.test('ContextBar: usa color rojo cuando porcentaje > 90%', async (stage) => {
                const el = document.createElement('context-bar');
                el.update(9500, 10000); // 95%
                stage.appendChild(el);
                await el.updateComplete;
                
                const bar = el.shadowRoot.querySelector('.bar');
                runner.assertTrue(bar.classList.contains('red'), 'Debe tener clase red sobre 90%');
            });

            // ========================================
            // TEST 12: Actualizaci√≥n reactiva
            // ========================================
            runner.test('ContextBar: actualiza color al cambiar porcentaje', async (stage) => {
                const el = document.createElement('context-bar');
                el.update(3000, 10000); // 30% - verde
                stage.appendChild(el);
                await el.updateComplete;
                
                let bar = el.shadowRoot.querySelector('.bar');
                runner.assertTrue(bar.classList.contains('green'), 'Debe empezar verde');
                
                el.update(9500, 10000); // 95% - rojo
                await el.updateComplete;
                
                bar = el.shadowRoot.querySelector('.bar');
                runner.assertTrue(bar.classList.contains('red'), 'Debe cambiar a rojo');
                runner.assertFalse(bar.classList.contains('green'), 'NO debe tener clase verde');
            });

            // ========================================
            // TEST 13: Barra no excede 100%
            // ========================================
            runner.test('ContextBar: barra no excede 100% visualmente', async (stage) => {
                const el = document.createElement('context-bar');
                el.update(15000, 10000); // 150% (sobre l√≠mite)
                stage.appendChild(el);
                await el.updateComplete;
                
                const bar = el.shadowRoot.querySelector('.bar');
                const barStyle = window.getComputedStyle(bar);
                
                // El estilo debe limitar el ancho al 100%
                // Verificamos que no es mayor que el contenedor
                runner.assertTrue(bar, 'Barra debe existir incluso con valores sobre 100%');
            });
        });

        runner.run();
    </script>
</body>
</html>
