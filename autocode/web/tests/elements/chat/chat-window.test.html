<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Window - Unit Tests</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 bg-gray-100 min-h-screen">
    <div class="flex items-center gap-4 mb-2">
        <a href="/tests" class="text-indigo-600 hover:text-indigo-800">‚Üê Tests</a>
        <h1 class="text-3xl font-bold">ü™ü Chat Window - Unit Tests</h1>
    </div>
    
    <div id="summary" class="mb-6 p-4 bg-white rounded-lg shadow"></div>
    <div id="results" class="space-y-2"></div>

    <script type="module">
        import { TestRunner } from '../../utils/test-runner.js'; 
        
        import '/elements/chat/chat-window.js';
        
        // Dependencias para tests de slots
        try { await import('/elements/chat/chat-input.js'); } catch {}
        try { await import('/elements/chat/chat-messages.js'); } catch {}

        const runner = new TestRunner();

        runner.group('ChatWindow', () => {
            // ========================================
            // TEST 1: Registro del Custom Element
            // ========================================
            runner.test('ChatWindow: se registra como custom element', async () => {
                await runner.waitForElement('chat-window');
                runner.assertTrue(customElements.get('chat-window'));
            });

            // ========================================
            // TEST 2: Shadow DOM
            // ========================================
            runner.test('ChatWindow: tiene shadowRoot', async (stage) => {
                const el = document.createElement('chat-window');
                stage.appendChild(el);
                await el.updateComplete;
                
                runner.assertTrue(el.shadowRoot, 'Debe tener shadowRoot');
            });

            // ========================================
            // TEST 3: Propiedad open (inicial)
            // ========================================
            runner.test('ChatWindow: open es false por defecto', async (stage) => {
                const el = document.createElement('chat-window');
                stage.appendChild(el);
                await el.updateComplete;
                
                runner.assertFalse(el.open, 'Propiedad open debe ser false por defecto');
            });

            // ========================================
            // TEST 4: API toggle()
            // ========================================
            runner.test('ChatWindow: toggle() cambia propiedad open', async (stage) => {
                const el = document.createElement('chat-window');
                stage.appendChild(el);
                await el.updateComplete;
                
                runner.assertFalse(el.open, 'Debe empezar cerrado');
                
                el.toggle();
                await el.updateComplete;
                runner.assertTrue(el.open, 'Debe abrirse tras primer toggle');
                
                el.toggle();
                await el.updateComplete;
                runner.assertFalse(el.open, 'Debe cerrarse tras segundo toggle');
            });

            // ========================================
            // TEST 5: API openWindow()
            // ========================================
            runner.test('ChatWindow: openWindow() abre la ventana', async (stage) => {
                const el = document.createElement('chat-window');
                stage.appendChild(el);
                await el.updateComplete;
                
                el.openWindow();
                await el.updateComplete;
                
                runner.assertTrue(el.open, 'Propiedad open debe ser true');
            });

            // ========================================
            // TEST 6: API close()
            // ========================================
            runner.test('ChatWindow: close() cierra la ventana', async (stage) => {
                const el = document.createElement('chat-window');
                stage.appendChild(el);
                el.openWindow();
                await el.updateComplete;
                
                runner.assertTrue(el.open, 'Debe estar abierto');
                
                el.close();
                await el.updateComplete;
                
                runner.assertFalse(el.open, 'Debe estar cerrado tras close()');
            });

            // ========================================
            // TEST 7: Evento toggle
            // ========================================
            runner.test('ChatWindow: emite evento toggle con detail.open', async (stage) => {
                const el = document.createElement('chat-window');
                stage.appendChild(el);
                await el.updateComplete;
                
                let toggleEventFired = false;
                let toggleDetail = null;
                el.addEventListener('toggle', (e) => {
                    toggleEventFired = true;
                    toggleDetail = e.detail;
                });
                
                el.toggle();
                
                runner.assertTrue(toggleEventFired, 'Debe emitir evento toggle');
                runner.assertTrue(toggleDetail.open, 'Detail debe incluir open=true');
            });

            // ========================================
            // TEST 8: Evento close
            // ========================================
            runner.test('ChatWindow: emite evento close al cerrar', async (stage) => {
                const el = document.createElement('chat-window');
                stage.appendChild(el);
                el.openWindow();
                await el.updateComplete;
                
                let closeEventFired = false;
                el.addEventListener('close', () => {
                    closeEventFired = true;
                });
                
                el.close();
                
                runner.assertTrue(closeEventFired, 'Debe emitir evento close');
            });

            // ========================================
            // TEST 9: Propiedad title
            // ========================================
            runner.test('ChatWindow: title configurable via atributo', async (stage) => {
                const el = document.createElement('chat-window');
                el.setAttribute('title', 'Mi Chat Personalizado');
                stage.appendChild(el);
                await el.updateComplete;
                
                runner.assertEqual(el.title, 'Mi Chat Personalizado', 'Propiedad title debe reflejar atributo');
                
                // Verificar renderizaci√≥n
                const titleEl = el.shadowRoot.querySelector('.header-title');
                runner.assertTrue(titleEl.textContent.includes('Mi Chat Personalizado'), 'Debe renderizar el t√≠tulo');
            });

            // ========================================
            // TEST 10: Visibilidad del panel
            // ========================================
            runner.test('ChatWindow: panel se muestra/oculta seg√∫n propiedad open', async (stage) => {
                const el = document.createElement('chat-window');
                stage.appendChild(el);
                await el.updateComplete;
                
                // Cerrado: panel debe tener clase hidden
                let panel = el.shadowRoot.querySelector('.panel');
                runner.assertTrue(panel.classList.contains('hidden'), 'Panel debe tener clase hidden cuando open=false');
                
                // Abrir
                el.openWindow();
                await el.updateComplete;
                panel = el.shadowRoot.querySelector('.panel');
                runner.assertFalse(panel.classList.contains('hidden'), 'Panel NO debe tener clase hidden cuando open=true');
            });

            // ========================================
            // TEST 11: Slots - Light DOM
            // ========================================
            runner.test('ChatWindow: acepta elementos con atributos slot en Light DOM', async (stage) => {
                const el = document.createElement('chat-window');
                el.innerHTML = `
                    <span slot="header-actions">Custom Action</span>
                    <div slot="content">Custom Content</div>
                    <div slot="footer">Custom Footer</div>
                `;
                stage.appendChild(el);
                await el.updateComplete;
                
                // Los elementos slotted permanecen en Light DOM del host
                runner.assertTrue(el.querySelector('[slot="header-actions"]'), 'Debe contener slot header-actions');
                runner.assertTrue(el.querySelector('[slot="content"]'), 'Debe contener slot content');
                runner.assertTrue(el.querySelector('[slot="footer"]'), 'Debe contener slot footer');
            });

            // ========================================
            // TEST 12: Slots - Proyecci√≥n en Shadow DOM
            // ========================================
            runner.test('ChatWindow: slots proyectan contenido correctamente', async (stage) => {
                const el = document.createElement('chat-window');
                el.innerHTML = `
                    <button slot="header-actions" id="test-btn">Test Action</button>
                    <div slot="content" id="test-content">Content Area</div>
                    <div slot="footer" id="test-footer">
                        <input type="text" placeholder="Test input">
                    </div>
                `;
                stage.appendChild(el);
                await el.updateComplete;
                
                // Verificar que los slots en shadow DOM existen
                const headerSlot = el.shadowRoot.querySelector('slot[name="header-actions"]');
                const contentSlot = el.shadowRoot.querySelector('slot[name="content"]');
                const footerSlot = el.shadowRoot.querySelector('slot[name="footer"]');
                
                runner.assertTrue(headerSlot, 'Debe tener slot header-actions en shadow DOM');
                runner.assertTrue(contentSlot, 'Debe tener slot content en shadow DOM');
                runner.assertTrue(footerSlot, 'Debe tener slot footer en shadow DOM');
                
                // Verificar que el contenido slotted es accesible desde Light DOM
                runner.assertTrue(el.querySelector('#test-btn'), 'Bot√≥n debe existir en Light DOM');
                runner.assertTrue(el.querySelector('#test-footer input'), 'Input debe existir en Light DOM');
            });

            // ========================================
            // TEST 13: Slots con componentes web
            // ========================================
            runner.test('ChatWindow: proyecta componentes web en slots', async (stage) => {
                const el = document.createElement('chat-window');
                el.innerHTML = `
                    <chat-messages slot="content"></chat-messages>
                    <div slot="footer">
                        <chat-input placeholder="Test"></chat-input>
                    </div>
                `;
                
                stage.appendChild(el);
                el.openWindow();
                await el.updateComplete;
                await runner.sleep(50);
                
                // Verificar que los componentes existen en Light DOM
                const chatMessages = el.querySelector('chat-messages');
                const chatInput = el.querySelector('chat-input');
                
                runner.assertTrue(chatMessages, 'chat-messages debe existir');
                runner.assertTrue(chatInput, 'chat-input debe existir');
                
                // Verificar que chat-input tiene su shadow DOM funcional
                await chatInput.updateComplete;
                const inputInShadow = chatInput.shadowRoot.querySelector('input');
                runner.assertTrue(inputInShadow, 'chat-input debe tener input funcional en su shadow DOM');
            });

            // ========================================
            // TEST 14: Bot√≥n de toggle flotante
            // ========================================
            runner.test('ChatWindow: renderiza bot√≥n de toggle flotante', async (stage) => {
                const el = document.createElement('chat-window');
                stage.appendChild(el);
                await el.updateComplete;
                
                const toggleBtn = el.shadowRoot.querySelector('.toggle-btn');
                runner.assertTrue(toggleBtn, 'Debe tener bot√≥n de toggle');
            });

            // ========================================
            // TEST 15: Click en bot√≥n de toggle
            // ========================================
            runner.test('ChatWindow: click en bot√≥n de toggle abre/cierra ventana', async (stage) => {
                const el = document.createElement('chat-window');
                stage.appendChild(el);
                await el.updateComplete;
                
                const toggleBtn = el.shadowRoot.querySelector('.toggle-btn');
                
                runner.assertFalse(el.open, 'Debe empezar cerrado');
                
                toggleBtn.click();
                await el.updateComplete;
                runner.assertTrue(el.open, 'Debe abrirse al hacer click');
                
                toggleBtn.click();
                await el.updateComplete;
                runner.assertFalse(el.open, 'Debe cerrarse al hacer click de nuevo');
            });
        });

        runner.run();
    </script>
</body>
</html>
