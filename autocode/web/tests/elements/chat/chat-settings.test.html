<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Settings - Unit Tests</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 bg-gray-100 min-h-screen">
    <div class="flex items-center gap-4 mb-2">
        <a href="/tests" class="text-indigo-600 hover:text-indigo-800">← Tests</a>
        <h1 class="text-3xl font-bold">⚙️ Chat Settings - Unit Tests</h1>
    </div>
    
    <div id="summary" class="mb-6 p-4 bg-white rounded-lg shadow"></div>
    <div id="results" class="space-y-2"></div>

    <script type="module">
        import { TestRunner } from '../../utils/test-runner.js'; 
        
        // Importar el componente
        import '/elements/chat/chat-settings.js';

        const runner = new TestRunner();
        
        // Mock de funcInfo realista basado en la función chat
        const mockFuncInfo = {
            name: 'chat',
            description: 'Chat function',
            http_methods: ['POST'],
            parameters: [
                {
                    name: 'model',
                    type: 'str',
                    required: false,
                    default: 'gpt-4o',
                    description: 'Model to use',
                    choices: ['gpt-4o', 'claude-3', 'grok-beta']
                },
                {
                    name: 'temperature',
                    type: 'float',
                    required: false,
                    default: 0.7,
                    description: 'Creativity level'
                },
                {
                    name: 'max_tokens',
                    type: 'int',
                    required: false,
                    default: 1000,
                    description: 'Max tokens to generate'
                },
                {
                    name: 'module_type',
                    type: 'str',
                    required: false,
                    default: 'ReAct',
                    description: 'DSPy Module Type',
                    choices: ['ReAct', 'ChainOfThought']
                },
                {
                    name: 'is_pro',
                    type: 'bool',
                    required: false,
                    default: false,
                    description: 'Enable pro features'
                },
                // Parámetros que deben ser ignorados
                {
                    name: 'message',
                    type: 'str',
                    required: true,
                    description: 'User message'
                },
                {
                    name: 'conversation_history',
                    type: 'str',
                    required: false,
                    default: '',
                    description: 'Chat history'
                }
            ]
        };

        runner.group('ChatSettings', () => {
            // ========================================
            // TEST 1: Registro del Custom Element
            // ========================================
            runner.test('ChatSettings: se registra como custom element', async () => {
                await runner.waitForElement('chat-settings');
                runner.assertTrue(customElements.get('chat-settings'));
            });

            // ========================================
            // TEST 2: API configure() - Inicialización
            // ========================================
            runner.test('ChatSettings: configure() inicializa settings con defaults', async (stage) => {
                const el = document.createElement('chat-settings');
                stage.appendChild(el);
                
                // Configurar con funcInfo
                el.configure(mockFuncInfo);
                await el.updateComplete; // Esperar render de Lit
                
                const settings = el.getSettings();
                
                runner.assertEqual(settings.model, 'gpt-4o', 'Model default debe ser gpt-4o');
                runner.assertEqual(settings.temperature, 0.7, 'Temperature default debe ser 0.7');
                runner.assertEqual(settings.max_tokens, 1000, 'Max tokens default debe ser 1000');
                runner.assertEqual(settings.module_type, 'ReAct', 'Module type default debe ser ReAct');
                runner.assertEqual(settings.is_pro, false, 'is_pro default debe ser false');
            });

            // ========================================
            // TEST 3: API getSettings() - Estructura
            // ========================================
            runner.test('ChatSettings: getSettings() retorna objeto estructurado', async (stage) => {
                const el = document.createElement('chat-settings');
                stage.appendChild(el);
                el.configure(mockFuncInfo);
                await el.updateComplete;
                
                const settings = el.getSettings();
                
                runner.assertTrue(typeof settings === 'object', 'Debe retornar objeto');
                runner.assertTrue('model' in settings, 'Debe incluir model');
                runner.assertTrue('temperature' in settings, 'Debe incluir temperature');
                runner.assertTrue('max_tokens' in settings, 'Debe incluir max_tokens');
                runner.assertTrue('module_type' in settings, 'Debe incluir module_type');
                runner.assertTrue('is_pro' in settings, 'Debe incluir is_pro');
            });

            // ========================================
            // TEST 4: Evento settings-change (inicial)
            // ========================================
            runner.test('ChatSettings: emite settings-change tras configure()', async (stage) => {
                const el = document.createElement('chat-settings');
                stage.appendChild(el);
                
                let eventFired = false;
                let eventDetail = null;
                
                el.addEventListener('settings-change', (e) => {
                    eventFired = true;
                    eventDetail = e.detail;
                });
                
                el.configure(mockFuncInfo);
                await el.updateComplete;
                
                runner.assertTrue(eventFired, 'Debe emitir evento settings-change');
                runner.assertTrue(eventDetail !== null, 'Evento debe incluir detail');
                runner.assertEqual(eventDetail.model, 'gpt-4o', 'Detail debe incluir defaults');
            });

            // ========================================
            // TEST 5: Actualización programática
            // ========================================
            runner.test('ChatSettings: _updateSetting() modifica y emite evento', async (stage) => {
                const el = document.createElement('chat-settings');
                stage.appendChild(el);
                el.configure(mockFuncInfo);
                await el.updateComplete;
                
                let eventFired = false;
                let eventDetail = null;
                
                el.addEventListener('settings-change', (e) => {
                    eventFired = true;
                    eventDetail = e.detail;
                });
                
                // Actualizar temperature
                el._updateSetting('temperature', 0.9);
                await el.updateComplete;
                
                runner.assertTrue(eventFired, 'Debe emitir evento tras actualización');
                runner.assertEqual(eventDetail.temperature, 0.9, 'Evento debe incluir nuevo valor');
                runner.assertEqual(el.getSettings().temperature, 0.9, 'getSettings() debe reflejar cambio');
            });

            // ========================================
            // TEST 6: Actualización de modelo
            // ========================================
            runner.test('ChatSettings: _updateSetting() cambia modelo correctamente', async (stage) => {
                const el = document.createElement('chat-settings');
                stage.appendChild(el);
                el.configure(mockFuncInfo);
                await el.updateComplete;
                
                let eventDetail = null;
                el.addEventListener('settings-change', (e) => {
                    eventDetail = e.detail;
                });
                
                el._updateSetting('model', 'claude-3');
                await el.updateComplete;
                
                runner.assertEqual(eventDetail.model, 'claude-3', 'Debe actualizar modelo');
                runner.assertEqual(el.getSettings().model, 'claude-3', 'getSettings() debe tener nuevo modelo');
            });

            // ========================================
            // TEST 7: Actualización de boolean
            // ========================================
            runner.test('ChatSettings: _updateSetting() maneja booleans correctamente', async (stage) => {
                const el = document.createElement('chat-settings');
                stage.appendChild(el);
                el.configure(mockFuncInfo);
                await el.updateComplete;
                
                el._updateSetting('is_pro', true);
                await el.updateComplete;
                
                runner.assertEqual(el.getSettings().is_pro, true, 'Debe actualizar boolean a true');
                
                el._updateSetting('is_pro', false);
                await el.updateComplete;
                
                runner.assertEqual(el.getSettings().is_pro, false, 'Debe actualizar boolean a false');
            });

            // ========================================
            // TEST 8: Renderización de controles
            // ========================================
            runner.test('ChatSettings: renderiza controles tras configure()', async (stage) => {
                const el = document.createElement('chat-settings');
                stage.appendChild(el);
                
                el.configure(mockFuncInfo);
                await el.updateComplete;
                
                // Forzar apertura del panel para verificar controles
                el._isOpen = true;
                await el.updateComplete;
                
                // Verificar que existen controles en el shadow DOM
                const inputs = el.shadowRoot.querySelectorAll('input, select');
                runner.assertTrue(inputs.length > 0, 'Debe tener al menos un control (input/select)');
            });

            // ========================================
            // TEST 9: Filtrado de parámetros excluidos
            // ========================================
            runner.test('ChatSettings: NO incluye message ni conversation_history en settings', async (stage) => {
                const el = document.createElement('chat-settings');
                stage.appendChild(el);
                
                el.configure(mockFuncInfo);
                await el.updateComplete;
                
                const settings = el.getSettings();
                
                runner.assertFalse('message' in settings, 'NO debe incluir message');
                runner.assertFalse('conversation_history' in settings, 'NO debe incluir conversation_history');
            });

            // ========================================
            // TEST 10: Múltiples actualizaciones
            // ========================================
            runner.test('ChatSettings: múltiples actualizaciones mantienen estado consistente', async (stage) => {
                const el = document.createElement('chat-settings');
                stage.appendChild(el);
                el.configure(mockFuncInfo);
                await el.updateComplete;
                
                // Realizar múltiples cambios
                el._updateSetting('temperature', 0.5);
                el._updateSetting('model', 'grok-beta');
                el._updateSetting('max_tokens', 2000);
                el._updateSetting('is_pro', true);
                await el.updateComplete;
                
                const settings = el.getSettings();
                
                runner.assertEqual(settings.temperature, 0.5, 'Temperature debe persistir');
                runner.assertEqual(settings.model, 'grok-beta', 'Model debe persistir');
                runner.assertEqual(settings.max_tokens, 2000, 'Max tokens debe persistir');
                runner.assertEqual(settings.is_pro, true, 'is_pro debe persistir');
            });
        });

        runner.run();
    </script>
</body>
</html>
