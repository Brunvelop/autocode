<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Debug Info - Unit Tests</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 bg-gray-100 min-h-screen">
    <div class="flex items-center gap-4 mb-2">
        <a href="/tests" class="text-indigo-600 hover:text-indigo-800">‚Üê Tests</a>
        <h1 class="text-3xl font-bold">üêû Chat Debug Info - Unit Tests</h1>
    </div>
    
    <div id="summary" class="mb-6 p-4 bg-white rounded-lg shadow"></div>
    <div id="results" class="space-y-2"></div>

    <script type="module">
        import { TestRunner } from '../../utils/test-runner.js'; 
        
        import '/elements/chat/chat-debug-info.js';

        const runner = new TestRunner();

        // Datos de prueba basados en ejemplos reales
        const mockResponse = {
            "result": "¬°Hola! ¬øEn qu√© puedo ayudarte hoy?",
            "success": true,
            "message": "Generaci√≥n exitosa",
            "history": [
                {
                    "prompt": null,
                    "messages": [],
                    "response": {
                        "id": "gen-123",
                        "model": "x-ai/grok-code-fast-1",
                        "usage": {
                            "completion_tokens": 205,
                            "prompt_tokens": 444,
                            "total_tokens": 649
                        },
                        "provider": "xAI"
                    },
                    "timestamp": "2025-11-26T12:29:23.534618",
                    "model": "openrouter/x-ai/grok-code-fast-1"
                }
            ]
        };

        const mockSimpleResponse = {
            "result": "Simple response without history",
            "success": true
        };

        const mockResponseWithRootUsage = {
            "result": "Response with usage at root level",
            "model": "gpt-4o",
            "usage": {
                "prompt_tokens": 100,
                "completion_tokens": 50,
                "total_tokens": 150
            }
        };

        runner.group('ChatDebugInfo', () => {
            // ========================================
            // TEST 1: Registro del Custom Element
            // ========================================
            runner.test('ChatDebugInfo: se registra como custom element', async () => {
                await runner.waitForElement('chat-debug-info');
                runner.assertTrue(customElements.get('chat-debug-info'));
            });

            // ========================================
            // TEST 2: Propiedad data
            // ========================================
            runner.test('ChatDebugInfo: propiedad data es reactiva', async (stage) => {
                const el = document.createElement('chat-debug-info');
                stage.appendChild(el);
                await el.updateComplete;
                
                runner.assertEqual(el.data, null, 'data debe ser null por defecto');
                
                el.data = mockResponse;
                await el.updateComplete;
                
                runner.assertEqual(el.data, mockResponse, 'data debe actualizarse');
            });

            // ========================================
            // TEST 3: Renderizado b√°sico con datos
            // ========================================
            runner.test('ChatDebugInfo: renderiza estructura b√°sica con datos', async (stage) => {
                const el = document.createElement('chat-debug-info');
                stage.appendChild(el);
                
                el.data = mockResponse;
                await el.updateComplete;
                
                const details = el.shadowRoot.querySelector('details');
                runner.assertTrue(details, 'Debe renderizar un elemento details');
                runner.assertFalse(details.hasAttribute('open'), 'Debe estar cerrado por defecto');
            });

            // ========================================
            // TEST 4: Sin datos, no renderiza nada
            // ========================================
            runner.test('ChatDebugInfo: no renderiza nada sin datos', async (stage) => {
                const el = document.createElement('chat-debug-info');
                stage.appendChild(el);
                await el.updateComplete;
                
                const details = el.shadowRoot.querySelector('details');
                runner.assertFalse(details, 'NO debe renderizar nada sin datos');
            });

            // ========================================
            // TEST 5: Extracci√≥n de m√©tricas desde history
            // ========================================
            runner.test('ChatDebugInfo: extrae m√©tricas desde history correctamente', async (stage) => {
                const el = document.createElement('chat-debug-info');
                stage.appendChild(el);
                
                el.data = mockResponse;
                await el.updateComplete;
                
                // Verificar que muestra el total de tokens
                const content = el.shadowRoot.textContent;
                runner.assertTrue(content.includes('649'), 'Debe mostrar total de tokens (649)');
                runner.assertTrue(content.includes('444'), 'Debe mostrar prompt tokens (444)');
                runner.assertTrue(content.includes('205'), 'Debe mostrar completion tokens (205)');
            });

            // ========================================
            // TEST 6: Extracci√≥n de modelo
            // ========================================
            runner.test('ChatDebugInfo: extrae y muestra nombre del modelo', async (stage) => {
                const el = document.createElement('chat-debug-info');
                stage.appendChild(el);
                
                el.data = mockResponse;
                await el.updateComplete;
                
                const content = el.shadowRoot.textContent;
                // Debe mostrar solo el nombre corto del modelo
                runner.assertTrue(content.includes('grok-code-fast-1'), 'Debe mostrar nombre del modelo');
            });

            // ========================================
            // TEST 7: Extracci√≥n desde root level
            // ========================================
            runner.test('ChatDebugInfo: extrae m√©tricas desde root level', async (stage) => {
                const el = document.createElement('chat-debug-info');
                stage.appendChild(el);
                
                el.data = mockResponseWithRootUsage;
                await el.updateComplete;
                
                const content = el.shadowRoot.textContent;
                runner.assertTrue(content.includes('150'), 'Debe extraer total tokens desde root');
                runner.assertTrue(content.includes('gpt-4o'), 'Debe extraer modelo desde root');
            });

            // ========================================
            // TEST 8: Graceful degradation sin metadatos
            // ========================================
            runner.test('ChatDebugInfo: maneja respuestas sin metadatos', async (stage) => {
                const el = document.createElement('chat-debug-info');
                stage.appendChild(el);
                
                el.data = mockSimpleResponse;
                await el.updateComplete;
                
                const summary = el.shadowRoot.querySelector('summary');
                runner.assertTrue(summary, 'Debe renderizar summary incluso sin metadatos');
                runner.assertTrue(
                    summary.textContent.includes('Info T√©cnica') || summary.textContent.includes('Debug'),
                    'Debe mostrar t√≠tulo gen√©rico'
                );
            });

            // ========================================
            // TEST 9: Muestra JSON completo
            // ========================================
            runner.test('ChatDebugInfo: muestra JSON completo en bloque pre', async (stage) => {
                const el = document.createElement('chat-debug-info');
                stage.appendChild(el);
                
                el.data = mockResponse;
                await el.updateComplete;
                
                const jsonPre = el.shadowRoot.querySelector('pre');
                runner.assertTrue(jsonPre, 'Debe tener un bloque pre para JSON');
                
                // Verificar que el contenido es JSON v√°lido
                const jsonContent = JSON.parse(jsonPre.textContent);
                runner.assertEqual(jsonContent.result, mockResponse.result, 'JSON debe coincidir con datos originales');
            });

            // ========================================
            // TEST 10: Summary contiene informaci√≥n clave
            // ========================================
            runner.test('ChatDebugInfo: summary contiene informaci√≥n resumida', async (stage) => {
                const el = document.createElement('chat-debug-info');
                stage.appendChild(el);
                
                el.data = mockResponse;
                await el.updateComplete;
                
                const summary = el.shadowRoot.querySelector('summary');
                const summaryText = summary.textContent;
                
                // Debe contener tokens y modelo en el resumen
                runner.assertTrue(summaryText.includes('649'), 'Summary debe incluir tokens totales');
                runner.assertTrue(summaryText.includes('grok'), 'Summary debe incluir nombre del modelo');
            });

            // ========================================
            // TEST 11: M√©tricas detalladas en contenido expandible
            // ========================================
            runner.test('ChatDebugInfo: muestra m√©tricas detalladas al expandir', async (stage) => {
                const el = document.createElement('chat-debug-info');
                stage.appendChild(el);
                
                el.data = mockResponse;
                await el.updateComplete;
                
                // Buscar grid de m√©tricas (si existe)
                const metricsGrid = el.shadowRoot.querySelector('.metrics-grid');
                
                if (metricsGrid) {
                    runner.assertTrue(metricsGrid, 'Debe tener grid de m√©tricas');
                    const content = metricsGrid.textContent;
                    runner.assertTrue(content.includes('Prompt') || content.includes('444'), 'Debe mostrar m√©tricas de prompt');
                    runner.assertTrue(content.includes('Completion') || content.includes('205'), 'Debe mostrar m√©tricas de completion');
                }
            });
        });

        runner.run();
    </script>
</body>
</html>
